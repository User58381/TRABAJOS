<script>
// ...
async function cargarAlumnoPorID(id){
  $('#student-view').style.display='none';
  $('#alumno-nombre').textContent='Cargando…'; $('#alumno-id').textContent='';

  // 1) Lee bloques
  const [asis, reg, pre] = await Promise.all([
    loadBlock('asistencia'),
    loadBlock('registro'),
    loadBlock('presets')
  ]);

  // 2) Parseo y selección del alumno en REGISTRO (aquí sí hay ID)
  const entregas = parseRegistro(reg.cols, reg.rows);
  const presets  = parsePresets(pre.cols, pre.rows);
  let entAlumno  = entregas.filter(t => norm(t.id) === norm(id));

  // 3) Tomar nombre desde REGISTRO si existe
  const nombreDeRegistro = entAlumno.find(e => e.nombre)?.nombre || '';

  // 4) Preparar referencia con ID y (si se pudo) nombre
  const ref = { id, nombre: nombreDeRegistro || '' };

  // 5) Cruce Presets vs Entregas (faltantes / tarde / a tiempo)
  const uids   = new Map(entAlumno.filter(t => t.uidPreset).map(t => [t.uidPreset, t]));
  const claves = new Map(entAlumno.filter(t => !t.uidPreset).map(t => [
    [norm(t.materia), norm(String(t.numero).replace(/^trabajo\s*/i,'')),
     norm(t.origen),  norm(t.pagina), normDate(t.fechaObjetivo)].join('|'), t
  ]));

  const faltantes=[], tarde=[], atiempo=[];
  for (const p of presets){
    let e = uids.get(p.uid);
    if (!e){
      const k = [norm(p.materia), norm(String(p.numero).replace(/^trabajo\s*/i,'')),
                 norm(p.origen),  norm(p.pagina), normDate(p.fechaObjetivo)].join('|');
      e = claves.get(k);
    }
    if (e) { (e.atrasoDias > 0 ? tarde : atiempo).push(p); } else { faltantes.push(p); }
  }
  ALL = { faltantes, tarde, atiempo, presets };

  // 6) Obtener nombre desde ASISTENCIA si es posible; si no, usar el del REGISTRO; si no, dejar “Alumno”
  const iNom = asis.cols.findIndex(c => /^nombre/i.test(c));
  const iId  = asis.cols.findIndex(c => /^(id|matric)/i.test(c));
  let nombre = nombreDeRegistro;

  // Intentar por ID en Asistencia (si existiera columna de ID)
  if (!nombre && iId >= 0 && iNom >= 0) {
    const r = asis.rows.find(r => norm(r[iId]) === norm(id));
    if (r) nombre = String(r[iNom] || '');
  }
  // Intentar por NOMBRE en Asistencia (si ya lo obtuvimos del registro)
  if (iNom >= 0 && nombre) {
    // nada: ya tenemos nombre
  }

  $('#alumno-nombre').textContent = nombre || 'Alumno';
  $('#alumno-id').textContent     = 'ID: ' + id;

  // 7) Asistencia: semana, 30 días e histórica (buscando por ID o por nombre)
  const hoy = new Date();
  const [w0, w1] = weekRange(hoy);
  const aw  = asistenciaAlumno(asis.cols, asis.rows, ref, w0, w1);
  const a30 = asistenciaAlumno(asis.cols, asis.rows, ref,
                ymd(new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate()-30)), ymd(hoy));
  const ah  = asistenciaHistorica(asis.cols, asis.rows, ref);

  $('#stat-aswk').textContent   = aw.total  ? `${Math.round(aw.present/aw.total*100)}%  (${aw.present}/${aw.total})` : '–';
  $('#stat-as30').textContent   = a30.total ? `${Math.round(a30.present/a30.total*100)}%  (${a30.present}/${a30.total})` : '–';
  $('#stat-asHist').textContent = ah.total  ? `${Math.round(ah.present/ah.total*100)}%  (${ah.present}/${ah.total})` : '–';
  $('#stat-faltHist').textContent = ah.total ? `${ah.total - ah.present}` : '–';

  // 8) Selector y listas por trimestre
  TRI='ALL'; setTriChips(); renderLists();

  // 9) Mostrar
  $('#student-view').style.display='block';
  window.scrollTo({ top: document.body.offsetTop, behavior: 'smooth' });
}
</script>
