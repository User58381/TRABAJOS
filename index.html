<!doctype html>
<html lang="es" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aula Digital — Consulta para familias</title>
<style>
  :root{
    --bg:#f7f9ff; --card:#ffffff; --text:#0b1020; --muted:#516072; --accent:#2b6bff;
    --bd:#d9e3ff; --ok:#0ea371; --warn:#f0b429; --bad:#ef4444;
  }
  [data-theme="dark"]{
    --bg:#0c1220; --card:#101a34; --text:#eaf3ff; --muted:#93a6bc; --accent:#6aa9ff;
    --bd:#223056; --ok:#1ec48d; --warn:#ffce3a; --bad:#ff7a7a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:color-mix(in oklab, var(--card) 90%, transparent);backdrop-filter:blur(6px);
    border-bottom:1px solid var(--bd); padding:14px 16px; display:flex; gap:12px; align-items:center}
  header h1{font-size:18px;margin:0}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid var(--bd);color:var(--text)}
  .btn.small{padding:8px 10px;border-radius:10px}
  main{max-width:960px;margin:auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:16px}
  .hero{display:grid;gap:10px}
  .input{display:flex;gap:8px;flex-wrap:wrap}
  .input input{flex:1;min-width:260px;padding:12px 14px;border:1px solid var(--bd);border-radius:12px;background:white}
  [data-theme="dark"] .input input{background:#0d152b;color:var(--text)}
  .hint{color:var(--muted);font-size:13px}
  h2{margin:10px 0 8px 0}
  h3{margin:12px 0 8px 0}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--bd);margin-right:6px}
  .pill.bad{background:color-mix(in oklab, #fff 50%, var(--bad)); color:#5a0b0b; border-color:color-mix(in oklab, var(--bad), #fff 60%)}
  .pill.warn{background:color-mix(in oklab, #fff 50%, var(--warn)); color:#694b00; border-color:color-mix(in oklab, var(--warn), #fff 60%)}
  .pill.ok{background:color-mix(in oklab, #fff 50%, var(--ok)); color:#0b3e30; border-color:color-mix(in oklab, var(--ok), #fff 60%)}
  [data-theme="dark"] .pill.bad{color:#ffd0d0} [data-theme="dark"] .pill.warn{color:#ffeaa7} [data-theme="dark"] .pill.ok{color:#c6ffe8}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:840px){.grid2{grid-template-columns:1fr 1fr}}
  .list{display:grid;gap:8px}
  details{border:1px solid var(--bd);border-radius:12px;padding:8px 10px;background:color-mix(in oklab, var(--card) 94%, transparent)}
  summary{cursor:pointer;font-weight:700}
  .stat{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:10px}
  .k{color:var(--muted);font-size:12px}
  .v{font-weight:900;font-size:18px}
  .kbd{font-family:ui-monospace,Consolas,monospace;border:1px solid var(--bd);padding:2px 6px;border-radius:6px;background:color-mix(in oklab, var(--card) 80%, transparent)}
  .footer-note{margin-top:12px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>👪 Aula Digital — Consulta para familias</h1>
  <div class="right">
    <button id="themeBtn" class="btn ghost small" title="Cambiar tema">🌙 Oscuro</button>
  </div>
</header>

<main>
  <!-- Bloque de búsqueda -->
  <section class="card hero" id="search-card">
    <div>
      <h2>Busca a tu hijo(a)</h2>
      <p class="hint">Escribe el <b>ID de alumno</b> (por ejemplo <span class="kbd">IDEF2F55BB</span>). Si no lo conoces, empieza a escribir su nombre y selecciónalo.</p>
    </div>
    <div class="input">
      <input id="idInput" list="alumnos" placeholder="Escribe el ID o nombre del alumno…">
      <datalist id="alumnos"></datalist>
      <button id="goBtn" class="btn primary">Ver resultados</button>
      <button id="saveBtn" class="btn ghost">Recordar este ID</button>
    </div>
    <div class="hint">Este sitio <u>solo lee</u> los datos de la escuela para mostrar un resumen. Nada se modifica en la libreta.</div>
  </section>

  <!-- Vista alumno -->
  <section id="student-view" style="display:none; margin-top:14px">
    <div class="card">
      <h2 id="alumno-nombre">Alumno</h2>
      <div class="hint" id="alumno-id"></div>
      <div class="stat" style="margin-top:8px">
        <div><div class="k">Cumplimiento general</div><div class="v" id="stat-cump">–</div></div>
        <div><div class="k">Asistencia — 30 días</div><div class="v" id="stat-as30">–</div></div>
        <div><div class="k">Asistencia — semana</div><div class="v" id="stat-aswk">–</div></div>
        <div><div class="k">Entregas tarde</div><div class="v" id="stat-tarde">–</div></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <h3>Resumen por trimestres</h3>
        <div id="pills" style="margin-bottom:8px"></div>
        <div class="hint">M1 = Trimestre 1 · M2 = Trimestre 2 · M3 = Trimestre 3</div>
      </div>
      <div class="card">
        <h3>Totales generales</h3>
        <div id="totales"></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <h3>Trabajos faltantes</h3>
        <div id="faltantes" class="list"></div>
      </div>
      <div class="card">
        <h3>Entregados tarde</h3>
        <div id="tarde" class="list"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Entregados (a tiempo)</h3>
      <div id="atiempo" class="list"></div>
    </div>

    <p class="footer-note">Si detectas algún dato que no coincide, contacta a la escuela para verificar la captura en la libreta digital.</p>
  </section>
</main>

<script>
/* ====== CONFIG DE TU HOJA ====== */
const SHEET_ID = '1SWtGmXlf7WbNvUlJBDktXpDcq5OfJkHE75bH5nkxurk';
const GIDS = { puntos:'0', asistencia:'280572348', registro:'1343140445', presets:'104702199' };

/* Sugerencias (nombre → id) */
const SUGERENCIAS = [
  ["ANDRADE RIVERA LUIS EDUARDO","IDEF2F55BB"],
  ["ANTONIO MUÑOZ OBED","ID5FC1305D"],
  ["ANTONIO RUIZ EDWIN ELIAS","ID0F9AE021"],
  ["BARRON ARREDONDO ALLISON VALENTINA","ID94C011EA"],
  ["CAZARES VARGAS DANIELA MONSERRATH","IDCD6D4580"],
  ["CRUZ MENDEZ EDGAR PORFIRIO","ID63E4D152"],
  ["GARCIA GUERRA JOSE ALEXIS","ID1B0647ED"],
  ["GONZALEZ MORENO ALONDRA ELIZABETH","ID1E3C3F1A"],
  ["GUERRERO DURAN CESAR EDUARDO","ID2D96DDE0"],
  ["HERNANDEZ FERNANDO ARIADNA AISLINN","ID2187B000"],
  ["IBARRA DE LA CRUZ JUAN AARON","ID9C56C4D5"],
  ["JEREZ NOE JOSE EDUARDO","ID4AE49AF3"],
  ["JUAREZ GALLEGOS FRANCISCO DANIEL","IDB8AA6898"],
  ["JUAREZ GALLEGOS MARCELA","ID0DF59CD6"],
  ["LOPEZ MARTINEZ TADEO GONZALO","IDD6FC391A"],
  ["LOPEZ NUÑEZ KENDRA LIZET","IDFB481355"],
  ["MARQUEZ RODRIGUEZ MELISSA","ID0B35387B"],
  ["MARTINEZ HERNANDEZ DYLAN ALEXANDRO","ID0733503E"],
  ["MARTINEZ MARTINEZ IVAN JACOB","ID6A68A01A"],
  ["MARTINEZ OROZCO ALBA ALMA CAROLINA","ID83E38E53"],
  ["MEDRANO CARRANCO ABIGAIL","ID709BA531"],
  ["NORBERTO LOPEZ JAQUELINE","ID49D77559"],
  ["ONTIVEROS MEDINA SOFIA ABIGAIL","IDF2FA1ED5"],
  ["RAMIREZ LOPEZ GABRIEL ALBERTO","IDE2EFAE55"],
  ["RAZO CASTILLO MARIO FERNANDO","ID59F92594"],
  ["RENTERIA ESPINO ZURY ALEXANDRA","ID870FDC06"],
  ["RODRIGUEZ GARZA ZOE DAYANA","ID30148E08"],
  ["ROMERO TORRES DALEYZA YAMILETH","ID57B6BE62"],
  ["SAENZ KENDRA NICOLE","ID9BE2CA42"],
  ["SALAZAR BARRIOS DEREK ALEJANDRO","ID5C1635B2"],
  ["TORRES PUENTE NAOMI YAMILETH","IDD8214F73"],
];

/* ====== UTIL ====== */
const $=s=>document.querySelector(s);
const strip=s=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const norm=s=>strip(String(s||'').toLowerCase()).replace(/\s+/g,' ').trim();
const pad=n=>String(n).padStart(2,'0'); const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function normDate(s){const t=String(s||'').trim(); if(!t)return''; const a=/^(\d{4}-\d{2}-\d{2})/.exec(t); if(a) return a[1];
  const b=/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(t); if(b){const d=new Date(+b[3],b[2]-1,+b[1]); return ymd(d);}
  const n=Number(t.replace(',','.')); if(!Number.isNaN(n)){const base=new Date(1899,11,30);return ymd(new Date(base.getTime()+n*86400000));}
  const d=new Date(t); if(!isNaN(+d)) return ymd(d); return'';}
function isPresent(v){const s=norm(v); if(!s) return false; if(!Number.isNaN(+s)) return (+s)>0; const s2=s.replace(/\s+/g,''); if(/^1\(100%?\)$/.test(s2)) return true;
  return ['x','✓','✔','p','presente','si','sí','s','ok','true','asistio','asistió'].includes(s);}
function getDateCols(cols){return cols.map((c,i)=>normDate(String(c).trim())?i:-1).filter(i=>i>=0);}

/* ====== LECTORES ====== */
let _cbSeq=0;
function fetchGViz(sheetId, sheetName){
  return new Promise((resolve,reject)=>{
    const cb=`__cb_${Date.now()}_${++_cbSeq}`;
    const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?headers=1&tqx=out:json;responseHandler:${cb}&sheet=${encodeURIComponent(sheetName)}&ts=${Date.now()}`;
    const sc=document.createElement('script');
    const timeout=setTimeout(()=>{cleanup();reject(new Error('Timeout'))},12000);
    function cleanup(){clearTimeout(timeout); delete window[cb]; if(sc.parentNode) sc.parentNode.removeChild(sc); }
    window[cb]=(json)=>{cleanup(); try{
      let cols=(json.table?.cols||[]).map(c=>String(c.label||'').trim());
      let rows=(json.table?.rows||[]).map(r=>(r.c||[]).map(c=>c?.v ?? ''));
      const empty=cols.filter(c=>!c||/^[A-Z]$/.test(c)).length;
      if(empty>=Math.ceil(cols.length*0.5)&&rows.length){cols=rows[0].map(v=>String(v??'')); rows=rows.slice(1);}
      resolve({cols,rows});
    }catch(e){reject(e)} };
    sc.onerror=()=>{cleanup();reject(new Error('Error GViz'))};
    sc.src=url; document.head.appendChild(sc);
  });
}
async function fetchCSVByGid(sheetId,gid){
  const url=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&ts=${Date.now()}`;
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('CSV '+gid);
  const txt=await res.text(); const rows=parseCSV(txt); const cols=(rows.shift()||[]).map(v=>String(v??'')); return {cols,rows};
}
function parseCSV(t){
  const rows=[]; let row=[], cur='', q=false;
  for(let i=0;i<t.length;i++){const ch=t[i],nx=t[i+1];
    if(q){ if(ch==='"'&&nx==='"'){cur+='"';i++;} else if(ch==='"'){q=false;} else cur+=ch; }
    else { if(ch==='"'){q=true;} else if(ch===','){row.push(cur);cur='';}
      else if(ch==='\n'||ch==='\r'){ if(cur!==''||row.length){row.push(cur);rows.push(row);row=[];cur='';} }
      else cur+=ch; } }
  if(cur!==''||row.length){row.push(cur);rows.push(row);} return rows;
}

/* ====== PARSERS ====== */
function parseRegistro(cols,rows){
  const idx=n=>cols.findIndex(c=>norm(c)===norm(n));
  const iUID=cols.findIndex(c=>/uid[_ ]?preset/i.test(c));
  const iF=cols.findIndex(c=>/^fecha$/i.test(c));
  const iFO=cols.findIndex(c=>/fecha.*objetivo/i.test(c));
  const iID=cols.findIndex(c=>/^(id|matric)/i.test(c));
  const iNom=cols.findIndex(c=>/^nombre/i.test(c));
  const iMat=cols.findIndex(c=>/^materia$/i.test(c));
  const iNum=cols.findIndex(c=>/n.?trabajo|n.? ?°/i.test(c));
  const iOri=cols.findIndex(c=>/^origen$/i.test(c));
  const iPag=cols.findIndex(c=>/^p[aá]gina/i.test(c));
  const iPts=cols.findIndex(c=>/^puntos$/i.test(c));
  const iAtr=cols.findIndex(c=>/atraso/i.test(c));
  const iMom=cols.findIndex(c=>/^momento$/i.test(c));
  const iNomT=cols.findIndex(c=>/nombre.*trabajo/i.test(c));
  return rows.map(r=>{
    const fecha=String(r[iF]??'').trim(); const fo=String((iFO>=0?r[iFO]:'')??'').trim()||fecha;
    const atraso = (()=>{
      if(iAtr>=0 && r[iAtr]!=='' && r[iAtr]!=null) return +r[iAtr]||0;
      const d=new Date(fecha), o=new Date(fo); if(isNaN(+d)||isNaN(+o)) return 0; return Math.max(0, Math.round((d-o)/86400000));
    })();
    return { uidPreset:String((iUID>=0?r[iUID]:'')??'').trim(), fecha, fechaObjetivo:fo, id:String((iID>=0?r[iID]:'')??'').trim(),
      nombre:String((iNom>=0?r[iNom]:'')??'').trim(), materia:String((iMat>=0?r[iMat]:'')??'').trim(),
      numero:String((iNum>=0?r[iNum]:'')??'').trim(), origen:String((iOri>=0?r[iOri]:'')??'').trim(),
      pagina:String((iPag>=0?r[iPag]:'')??'').trim(), puntos:+((iPts>=0?r[iPts]:0)??0)||0,
      atrasoDias:atraso, momento:String((iMom>=0?r[iMom]:'')??'').trim(), nombreTrabajo:String((iNomT>=0?r[iNomT]:'')??'').trim()
    };
  });
}
function parsePresets(cols,rows){
  const iUID=cols.findIndex(c=>/uid[_ ]?preset/i.test(c));
  const iFO=cols.findIndex(c=>/fecha.*objetivo/i.test(c));
  const iMom=cols.findIndex(c=>/^momento$/i.test(c));
  const iMat=cols.findIndex(c=>/^materia$/i.test(c));
  const iNum=cols.findIndex(c=>/n.?trabajo|n.? ?°/i.test(c));
  const iOri=cols.findIndex(c=>/^origen$/i.test(c));
  const iPag=cols.findIndex(c=>/^p[aá]gina/i.test(c));
  const iNom=cols.findIndex(c=>/nombre.*trabajo/i.test(c));
  return rows.map(r=>({uid:String((iUID>=0?r[iUID]:'')??'').trim(),
    fechaObjetivo:String((iFO>=0?r[iFO]:'')??'').trim(), momento:String((iMom>=0?r[iMom]:'')??'').trim(),
    materia:String((iMat>=0?r[iMat]:'')??'').trim(), numero:String((iNum>=0?r[iNum]:'')??'').trim(),
    origen:String((iOri>=0?r[iOri]:'')??'').trim(), pagina:String((iPag>=0?r[iPag]:'')??'').trim(),
    nombreTrabajo:String((iNom>=0?r[iNom]:'')??'').trim()})).filter(p=>p.uid);
}

/* ====== ASISTENCIA ====== */
function asistenciaAlumno(cols,rows,ref,start,end){
  const iId=cols.findIndex(c=>/^(id|matric)/i.test(c));
  const iNom=cols.findIndex(c=>/^nombre/i.test(c));
  let row=null; if(iId>=0 && ref.id) row=rows.find(r=>norm(r[iId])===norm(ref.id));
  if(!row && iNom>=0 && ref.nombre) row=rows.find(r=>norm(r[iNom])===norm(ref.nombre));
  if(!row) return {present:0,total:0};
  const dateCols=getDateCols(cols).filter(i=>{const d=normDate(cols[i]); return d && d>=start && d<=end;});
  let present=0,total=0; for(const i of dateCols){const v=row[i]; if(v!==null&&v!==''){ total++; if(isPresent(v)) present++; } }
  return {present,total};
}
function weekRange(d){const day=d.getDay(); const diff=(day===0?-6:1-day); const mon=new Date(d); mon.setDate(d.getDate()+diff); mon.setHours(0,0,0,0);
  const fri=new Date(mon); fri.setDate(mon.getDate()+4); return [ymd(mon), ymd(fri)]; }

/* ====== CARGA Y RENDER ====== */
async function loadBlock(name){
  const sheetNames = {
    asistencia: 'Asistencia',
    registro: 'Registro de trabajos',
    presets: 'Presets'
  };
  try{ return await fetchGViz(SHEET_ID, sheetNames[name]); }
  catch{ return await fetchCSVByGid(SHEET_ID, GIDS[name]); }
}
async function cargarAlumno(ref){
  $('#student-view').style.display='none';
  const loaderText='Cargando…';
  $('#alumno-nombre').textContent=loaderText; $('#alumno-id').textContent='';

  // 1) Lee bloques
  const [asis, reg, pre] = await Promise.all([
    loadBlock('asistencia'),
    loadBlock('registro'),
    loadBlock('presets')
  ]);

  // 2) Parseo y filtrado
  const entregas=parseRegistro(reg.cols, reg.rows);
  const presets=parsePresets(pre.cols, pre.rows);

  let entAlumno=entregas.filter(t=>norm(t.id)===norm(ref.id));
  if(!entAlumno.length && ref.nombre){entAlumno=entregas.filter(t=>norm(t.nombre)===norm(ref.nombre));}

  // 3) Cruce Presets vs Entregas
  const uids=new Map(entAlumno.filter(t=>t.uidPreset).map(t=>[t.uidPreset,t]));
  const claves=new Map(entAlumno.filter(t=>!t.uidPreset).map(t=>[
    [norm(t.materia), norm(String(t.numero).replace(/^trabajo\s*/i,'')), norm(t.origen), norm(t.pagina), normDate(t.fechaObjetivo)].join('|'), t
  ]));

  const faltantes=[], tarde=[], atiempo=[];
  for(const p of presets){
    let e = uids.get(p.uid);
    if(!e){
      const k=[norm(p.materia), norm(String(p.numero).replace(/^trabajo\s*/i,'')), norm(p.origen), norm(p.pagina), normDate(p.fechaObjetivo)].join('|');
      e = claves.get(k);
    }
    if(e){ (e.atrasoDias>0 ? tarde : atiempo).push(p); } else { faltantes.push(p); }
  }

  // 4) Nombre/ID visible
  const guess = entAlumno[0]?.nombre ||
    (asis.rows.find(r=>norm(r[asis.cols.findIndex(c=>/^id/i.test(c))])===norm(ref.id))?.[asis.cols.findIndex(c=>/^nombre/i.test(c))]) || '';
  $('#alumno-nombre').textContent = guess || (ref.nombre || 'Alumno');
  $('#alumno-id').textContent = 'ID: ' + (ref.id || '(desconocido)');

  // 5) Asistencia (semana y 30 días)
  const hoy=new Date(); const [w0,w1]=weekRange(hoy);
  const aw=asistenciaAlumno(asis.cols, asis.rows, ref, w0, w1);
  const a30=asistenciaAlumno(asis.cols, asis.rows, ref, ymd(new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate()-30)), ymd(hoy));

  // 6) Totales y % cumplimiento
  const total=presets.length, hechos=atiempo.length + tarde.length;
  const pct = total ? Math.round((hechos/total)*100) : 0;

  // 7) Píldoras por trimestre
  const byM = m => (list)=>list.filter(x=>String(x.momento||'').toUpperCase()===m).length;
  const pillsHTML = ['M1','M2','M3'].map(m=>{
    const tot = presets.filter(p=>String(p.momento||'').toUpperCase()===m).length;
    const done = atiempo.filter(p=>String(p.momento||'').toUpperCase()===m).length + tarde.filter(p=>String(p.momento||'').toUpperCase()===m).length;
    const miss = faltantes.filter(p=>String(p.momento||'').toUpperCase()===m).length;
    const pctM = tot ? Math.round((done/tot)*100) : 0;
    return `<span class="pill ${miss? 'bad':'ok'}">${m}: ${done}/${tot} (${pctM}%) · faltantes ${miss}</span>`;
  }).join('');
  $('#pills').innerHTML = pillsHTML || '<span class="hint">No hay trimestres definidos.</span>';

  // 8) Totales
  $('#stat-cump').textContent = total ? `${pct}%  (${hechos}/${total})` : '–';
  $('#stat-as30').textContent = a30.total ? `${Math.round(a30.present/a30.total*100)}%  (${a30.present}/${a30.total})` : '–';
  $('#stat-aswk').textContent = aw.total ? `${Math.round(aw.present/aw.total*100)}%  (${aw.present}/${aw.total})` : '–';
  $('#stat-tarde').textContent = String(tarde.length);
  $('#totales').innerHTML = `
    <span class="pill bad">Faltantes: ${faltantes.length}</span>
    <span class="pill warn">Tarde: ${tarde.length}</span>
    <span class="pill ok">A tiempo: ${atiempo.length}</span>
  `;

  // 9) Listas
  const renderItem = (t) => {
    const mom = t.momento ? ` · ${t.momento}` : '';
    const fecha = t.fechaObjetivo ? ` · ${normDate(t.fechaObjetivo)}` : '';
    const nom = t.nombreTrabajo ? ` · <i>${t.nombreTrabajo}</i>` : '';
    return `<details><summary><b>${t.materia||'–'}</b> — ${t.numero||'–'} (${t.origen||'–'}${t.pagina?' · p.'+t.pagina:''})${nom}${fecha}${mom}</summary></details>`;
  };
  $('#faltantes').innerHTML = faltantes.length ? faltantes.map(renderItem).join('') : '<div class="hint">No hay trabajos faltantes 💙</div>';
  $('#tarde').innerHTML     = tarde.length     ? tarde.map(renderItem).join('')     : '<div class="hint">No hay entregas tarde</div>';
  $('#atiempo').innerHTML   = atiempo.length   ? atiempo.map(renderItem).join('')   : '<div class="hint">Aún no hay entregas registradas</div>';

  // 10) Mostrar
  $('#student-view').style.display='block';
  window.scrollTo({top:document.body.offsetTop, behavior:'smooth'});
}

/* ====== UI ====== */
function fillSugerencias(){
  const d=$('#alumnos'); d.innerHTML='';
  for(const [n,id] of SUGERENCIAS){ const o=document.createElement('option'); o.value=id; o.label=n; d.appendChild(o); }
}
function inferRefFromInput(v){
  const val=String(v||'').trim();
  const enSug=SUGERENCIAS.find(([n,id])=>id.toLowerCase()===val.toLowerCase() || n.toLowerCase()===val.toLowerCase());
  if(enSug) return {id:enSug[1], nombre:enSug[0]};
  // si parece ID (IDXXXXX…)
  if(/^ID[A-Z0-9]{6,}$/i.test(val) || /^I[A-Z0-9]{8,}$/i.test(val)) return {id:val};
  // si parece nombre
  return {id:'', nombre:val};
}

/* Tema */
const themeBtn=$('#themeBtn');
function applyTheme(t){document.documentElement.setAttribute('data-theme', t); themeBtn.textContent=(t==='dark'?'☀️ Claro':'🌙 Oscuro'); localStorage.setItem('familias_theme',t);}
applyTheme(localStorage.getItem('familias_theme')||'light');
themeBtn.onclick=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

/* Eventos */
fillSugerencias();
const saved=localStorage.getItem('familias_id'); if(saved) $('#idInput').value=saved;
$('#saveBtn').onclick=()=>{const v=$('#idInput').value.trim(); if(!v){alert('Escribe un ID o nombre.'); return;} localStorage.setItem('familias_id',v); alert('Listo. Guardado en este dispositivo.');};
$('#goBtn').onclick=async()=>{const ref=inferRefFromInput($('#idInput').value); if(!ref.id && !ref.nombre){alert('Escribe un ID o nombre.'); return;}
  try{await cargarAlumno(ref);}catch(e){alert('No fue posible leer los datos: '+e.message);}
};
$('#idInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ $('#goBtn').click(); }});
</script>
</body>
</html>
